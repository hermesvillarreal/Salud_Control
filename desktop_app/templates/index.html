<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Salud Control - Panel de Control</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <link rel="manifest" href="/static/manifest.json">
    <meta name="theme-color" content="#4CAF50">
    <link rel="apple-touch-icon" href="/static/icon.svg">
    <link rel="stylesheet" href="/static/style.css">
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function () {
                navigator.serviceWorker.register('/service-worker.js').then(function (registration) {
                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                }, function (err) {
                    console.log('ServiceWorker registration failed: ', err);
                });
            });
        }
    </script>
</head>

<body>
    <div class="header">
        <h1>Panel de Control de Salud</h1>
        <div style="position: absolute; top: 20px; right: 20px;">
            <a href="/logout" style="color: white; text-decoration: none; font-weight: bold;">Cerrar Sesi√≥n</a>
        </div>
    </div>

    <div class="container">
        <!-- Stats Section -->
        <div class="stats">
            <div class="stat-card">
                <h3>‚öñÔ∏è Peso</h3>
                <div class="stat-value"><span id="last-weight">--</span> <small>kg</small></div>
                <div class="stat-label">Promedio: <span id="avg-weight">--</span> kg</div>
            </div>
            <div class="stat-card">
                <h3>‚ù§Ô∏è Presi√≥n Arterial</h3>
                <div class="stat-value"><span id="last-bp">--/--</span></div>
                <div class="stat-label">Promedio: <span id="avg-bp">--/--</span></div>
            </div>
            <div class="stat-card">
                <h3>ü©∏ Glucosa</h3>
                <div class="stat-value"><span id="last-glucose">--</span> <small>mg/dL</small></div>
                <div class="stat-label">Promedio: <span id="avg-glucose">--</span> mg/dL</div>
            </div>
        </div>

        <!-- Charts Section -->
        <div id="charts-container">
            <div class="chart">
                <h2>üìâ Evoluci√≥n del Peso
                    <div class="tooltip-container">
                        <span class="info-icon">?</span>
                        <span class="tooltip-text">Muestra el √∫ltimo registro de peso de cada d√≠a para observar
                            tendencias a largo plazo.</span>
                    </div>
                </h2>
                <div id="weight-chart" class="chart-content">
                    <div class="loading-spinner"></div>
                </div>
            </div>

            <div class="chart">
                <h2>üíì Presi√≥n Arterial
                    <div class="tooltip-container">
                        <span class="info-icon">?</span>
                        <span class="tooltip-text">Compara la presi√≥n sist√≥lica (alta) y diast√≥lica (baja) a lo largo
                            del tiempo.</span>
                    </div>
                </h2>
                <div id="bp-chart" class="chart-content">
                    <div class="loading-spinner"></div>
                </div>
            </div>

            <div class="chart">
                <h2>üç¨ Niveles de Glucosa
                    <div class="tooltip-container">
                        <span class="info-icon">?</span>
                        <span class="tooltip-text">Seguimiento de los niveles de az√∫car en sangre registrados.</span>
                    </div>
                </h2>
                <div id="glucose-chart" class="chart-content">
                    <div class="loading-spinner"></div>
                </div>
            </div>

            <div class="chart">
                <h2>üçΩÔ∏è Calor√≠as por Comida (g)
                    <div class="tooltip-container">
                        <span class="info-icon">?</span>
                        <span class="tooltip-text">Suma total de gramos (Prote√≠na + Carbos + Grasa) consumidos en cada
                            tipo de comida por d√≠a.</span>
                    </div>
                </h2>
                <div id="meals-by-day-chart" class="chart-content">
                    <div class="loading-spinner"></div>
                </div>
            </div>

            <div class="chart">
                <h2>üìä Macronutrientes Diarios
                    <div class="tooltip-container">
                        <span class="info-icon">?</span>
                        <span class="tooltip-text">Distribuci√≥n diaria total de Prote√≠nas, Carbohidratos y
                            Grasas.</span>
                    </div>
                </h2>
                <div id="macros-by-day-chart" class="chart-content">
                    <div class="loading-spinner"></div>
                </div>
            </div>
        </div>

        <div id="error-container"></div>

        <div id="analysis-section" class="card">
            <h2>ü§ñ An√°lisis de Datos</h2>
            <div id="analysis-content">
                <p>Cargando an√°lisis...</p>
            </div>
        </div>
    </div>

    <!-- Floating Action Button -->
    <a href="/add_record" class="fab" title="Nuevo Registro">+</a>

    <script>
        // Funci√≥n para cargar los datos iniciales
        async function loadData() {
            const errorContainer = document.getElementById('error-container');
            errorContainer.innerHTML = ''; // Clear previous errors

            try {
                // Obtener estad√≠sticas generales y √∫ltimos registros
                const respStats = await fetch('/health_data');
                if (!respStats.ok) throw new Error('Error al conectar con el servidor');

                const statsData = await respStats.json();
                if (statsData.status === 'success') {
                    updateStats(statsData.data);
                } else {
                    throw new Error(statsData.message || 'Error desconocido al cargar datos');
                }

                // Obtener las gr√°ficas generadas para el usuario actual
                const respPlots = await fetch('/generate_plots');
                if (!respPlots.ok) throw new Error('Error al generar gr√°ficas');

                const plots = await respPlots.json();
                updatePlots(plots);

            } catch (error) {
                console.error('Error loading data:', error);
                showError(`No se pudieron cargar los datos: ${error.message}. <br> Aseg√∫rate de que el servidor est√© corriendo.`);
                // Remove spinners if error
                document.querySelectorAll('.loading-spinner').forEach(el => el.style.display = 'none');
            }
        }

        function showError(message) {
            const container = document.getElementById('error-container');
            container.innerHTML = `<div class="error-message">${message}</div>`;
        }

        // Funci√≥n para actualizar las estad√≠sticas
        function updateStats(data) {
            if (data.length > 0) {
                const latest = data[data.length - 1];

                document.getElementById('last-weight').textContent = latest.weight || '--';
                document.getElementById('last-bp').textContent =
                    (latest.blood_pressure_sys && latest.blood_pressure_dia) ?
                        `${latest.blood_pressure_sys}/${latest.blood_pressure_dia}` : '--/--';
                document.getElementById('last-glucose').textContent = latest.glucose_level || '--';

                // Calcular promedios (filtrando valores nulos/cero)
                const validWeights = data.filter(d => d.weight > 0);
                const avgWeight = validWeights.reduce((sum, d) => sum + d.weight, 0) / (validWeights.length || 1);

                const validSys = data.filter(d => d.blood_pressure_sys > 0);
                const avgSys = validSys.reduce((sum, d) => sum + d.blood_pressure_sys, 0) / (validSys.length || 1);
                const avgDia = validSys.reduce((sum, d) => sum + d.blood_pressure_dia, 0) / (validSys.length || 1);

                const validGlu = data.filter(d => d.glucose_level > 0);
                const avgGlucose = validGlu.reduce((sum, d) => sum + d.glucose_level, 0) / (validGlu.length || 1);

                document.getElementById('avg-weight').textContent = avgWeight.toFixed(1);
                document.getElementById('avg-bp').textContent =
                    `${avgSys.toFixed(0)}/${avgDia.toFixed(0)}`;
                document.getElementById('avg-glucose').textContent = avgGlucose.toFixed(1);
            }
        }

        // Funci√≥n para actualizar las gr√°ficas
        function updatePlots(plots) {
            const config = { responsive: true, displayModeBar: false };
            const layoutUpdate = {
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                font: { family: 'Segoe UI, sans-serif' },
                margin: { t: 10, l: 40, r: 20, b: 40 }
            };

            function renderPlot(id, plotData) {
                const container = document.getElementById(id);
                container.innerHTML = ''; // Remove spinner
                if (plotData) {
                    const data = JSON.parse(plotData);
                    // Merge layout updates
                    data.layout = { ...data.layout, ...layoutUpdate };
                    Plotly.newPlot(id, data.data, data.layout, config);
                } else {
                    container.innerHTML = '<p style="text-align:center; color:#888;">No hay datos suficientes</p>';
                }
            }

            renderPlot('weight-chart', plots.weight);
            renderPlot('bp-chart', plots.blood_pressure);
            renderPlot('glucose-chart', plots.glucose);
            renderPlot('meals-by-day-chart', plots.meals_by_day);
            renderPlot('macros-by-day-chart', plots.macros_by_day);
        }

        // Cargar datos cuando la p√°gina se carga
        document.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>

</html>